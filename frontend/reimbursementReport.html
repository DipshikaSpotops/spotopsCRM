<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UPS Claims / Reimbursement Report</title>

<script>
  if (localStorage.getItem("darkMode") === "true") {
    document.documentElement.classList.add("dark-mode");
  }
</script>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<link rel="stylesheet" href="/css/monthwiseOrders.css" />

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.43/builds/moment-timezone-with-data.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  var firstName = localStorage.getItem("firstName");
  if (!firstName) {
    window.location.href = "login_signup.html";
  }
</script>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo">
      <a href="index.html"><img id="logoImg" src="https://assets-autoparts.s3.ap-south-1.amazonaws.com/images/darkLogo.png" alt="Logo" /></a>
    </div>
    <div class="toggle-sidebar"><i class="fas fa-bars"></i></div>
    <div class="user-info dropdown" style="display:flex;">
      <span style="white-space:nowrap;margin-left:10px;">Hi <span id="user-name"></span></span>
      <div class="dark-mode-toggle"><i id="darkModeIcon" class="fas fa-moon" style="cursor:pointer;color:white;font-size:20px;"></i></div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="offcanvasSidebar">
    <div class="offcanvas-body">
      <nav class="nav flex-column">
        <div class="nav-item dashboards">
          <a class="nav-link menu" href="#" id="default-link"><i class="fas fa-home"></i> Dashboards</a>
          <div class="submenu" id="submenu-dashboards">
            <a class="nav-link" href="monthwiseOrders.html">View Orders- Monthly</a>
            <a class="nav-link" href="salesData.html">Sales Data</a>
            <a class="nav-link" href="cancelledOrders.html">Cancelled Orders</a>
            <a class="nav-link" href="refundedOrders.html">Refunded Orders</a>
            <a class="nav-link" href="disputes.html">Disputed Orders</a>
          </div>
        </div>
        <div class="nav-item">
          <a class="nav-link menu" href="#"><i class="fas fa-chart-bar"></i> Reports</a>
          <div class="submenu" id="submenu-reports">
            <a class="nav-link" href="reimbursementReport.html">Reimbursement Report</a>
          </div>
        </div>
      </nav>
    </div>
  </div>

  <!-- Main -->
  <div class="main-content">
    <div class="topHeads">
      <h1>UPS Claims / Reimbursements</h1>
      <div><input id="unifiedDatePicker" class="form-control" placeholder="Select date, range or month" readonly/></div>
      <button id="filterButton" class="btn btn-primary">Filter</button>
    </div>
    <div id="filterAndTotal" style="margin-top:10px;">
      <div id="showTotalOrders"><b>Total Orders: 0</b></div>
      <div id="showTotalReimbursed"><b>Total Reimbursed: $0.00</b></div>
      <div id="pagination-controls"></div>
      <div id="loadingMessage" style="display:none;"><b>Loading, please wait...</b></div>
    </div>

    <div class="table-wrapper">
      <table class="table table-bordered">
        <thead id="infoTableHeader">
          <tr id="tableHeader" style="background-color:#f2f2f2">
            <th data-column="orderNo" style="background-color:#037894;">Order No.</th>
            <th data-column="orderDate" style="background-color:#037894;">Order Date</th>
          </tr>
        </thead>
        <tbody id="yardInfoTable" style="text-align:center"></tbody>
        <tfoot id="tableFooter"></tfoot>
      </table>
    </div>
  </div>

<script>
$(document).ready(async function () {
  const token = localStorage.getItem("token");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const now = new Date();
  const initMonth = months[now.getMonth()];
  const initYear = now.getFullYear();

  let yardOrders = [];
  const rowsPerPage = 25;
  let currentPage = 1;

  $("#unifiedDatePicker").val(`${initYear}-${String(now.getMonth()+1).padStart(2,"0")}`);
  await fetchYardInfo(initMonth, initYear);

  // fetch
  async function fetchYardInfo(month, year) {
    try {
      $("#loadingMessage").show();
      const resp = await axios.get("https://www.spotops360.com/orders/monthly", {
        params: { month, year, page:1, limit:500 },
        headers: { Authorization: `Bearer ${token}` }
      });
      yardOrders = resp.data.orders || [];
      renderTableRows(currentPage);
      createPaginationControls(Math.ceil(yardOrders.length/rowsPerPage));
    } catch (err) {
      console.error(err);
      alert("Failed to load data");
    } finally {
      $("#loadingMessage").hide();
    }
  }

  // render
  function renderTableRows(page) {
    const start = (page-1)*rowsPerPage;
    const end = start+rowsPerPage;
    const pageData = yardOrders.slice(start,end);
    $("#yardInfoTable").empty();

    let totalReimbursed = 0;

    pageData.forEach(order=>{
      const dateObj = new Date(order.orderDate);
      const formatted = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
      const refund = Number(order.refundAmount||0);
      totalReimbursed += refund;

      $("#yardInfoTable").append(`
        <tr>
          <td>${order.orderNo}</td>
          <td>${formatted}</td>
          <td>$${refund.toFixed(2)}</td>
        </tr>
      `);
    });

    $("#showTotalOrders").html(`<b>Total Orders: ${yardOrders.length}</b>`);
    $("#showTotalReimbursed").html(`<b>Total Reimbursed: $${totalReimbursed.toFixed(2)}</b>`);
  }

  function createPaginationControls(totalPages) {
    const pagination = $("#pagination-controls");
    pagination.empty();
    if(totalPages>1){
      pagination.append(`<button id="prevPage" ${currentPage===1?"disabled":""}>←</button>`);
      pagination.append(`<span> Page ${currentPage} of ${totalPages} </span>`);
      pagination.append(`<button id="nextPage" ${currentPage===totalPages?"disabled":""}>→</button>`);
    }
  }

  $("#pagination-controls").on("click","#prevPage",function(){
    if(currentPage>1){currentPage--;renderTableRows(currentPage);createPaginationControls(Math.ceil(yardOrders.length/rowsPerPage));}
  });
  $("#pagination-controls").on("click","#nextPage",function(){
    const totalPages=Math.ceil(yardOrders.length/rowsPerPage);
    if(currentPage<totalPages){currentPage++;renderTableRows(currentPage);createPaginationControls(totalPages);}
  });

  // filter
  $("#filterButton").click(async function(){
    const val = $("#unifiedDatePicker").val().trim();
    if(val && /^\d{4}-\d{2}$/.test(val)){
      const y = val.split("-")[0];
      const m = months[parseInt(val.split("-")[1])-1];
      currentPage=1;
      await fetchYardInfo(m,y);
    } else {
      alert("Select valid YYYY-MM");
    }
  });

});
</script>
</body>
</html>
