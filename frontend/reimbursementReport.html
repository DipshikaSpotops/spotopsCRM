<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reimbursements</title>
<script>
if (localStorage.getItem('darkMode') === "true"){
  document.documentElement.classList.add('dark-mode');
}
</script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.43/builds/moment-timezone-with-data.min.js"></script>
<link rel="stylesheet" href="/css/monthwiseOrders.css" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
var firstName = localStorage.getItem("firstName");
if (!firstName) {
  window.location.href = "login_signup.html";
}
</script>
</head>
<body>
    <!-- navbar + sidebar code unchanged -->
    <div class="main-content">
      <div class="topHeads">
        <div>
          <h1 id="mainHeading">Reimbursements</h1>
        </div>
        <div>
          <input type="text" class="form-control" id="searchInput" placeholder="Search..."/>
        </div>
      </div>
      <div id="filterAndTotal">
        <div class="flatpickr-wrapper">
          <input id="unifiedDatePicker" class="form-control" placeholder="Select date, range or month" readonly/>
        </div>
        <button id="filterButton" class="btn btn-primary" >Filter</button>
        <div id="showTotalOrders">Total Orders -</div>
        <div id="pagination-controls"></div>
        <div id="loadingMessage" style="display: none;"><b>Loading, please wait...</b></div>
      </div>
      <div class="table-wrapper">
        <table class="table table-bordered">
          <thead id="infoTableHeader">
            <tr id="tableHeader" style="background-color: #f2f2f2">
              <th class="sortable" data-column="orderDate" style="background-color: #037894;">Order No.</th>
              <th class="sortable" data-column="orderNo" style="background-color: #037894;">Order Date</th>
            </tr>
          </thead>
          <tbody id="yardInfoTable" style="text-align: center"></tbody>
          <tfoot id="tableFooter"><tr></tr></tfoot>
        </table>
      </div>
    </div>

<script>
$(document).ready(async function () {
  // flatpickr setup
  const fp = flatpickr("#unifiedDatePicker", {
    mode: "range",
    dateFormat: "Y-m-d",
    allowInput: true,
    onOpen: function () {
      document.querySelector(".table-wrapper").classList.add("table-blur");
    },
    onClose: function () {
      document.querySelector(".table-wrapper").classList.remove("table-blur");
    }
  });

  let yardOrders = [];
  const rowsPerPage = 25;
  let currentPage = 1;

  // Fetch yard info (filtered by reimbursedDate)
  async function fetchYardInfo(month, year) {
    try {
      $("#loadingMessage").show();
      const limit = 25;
      const firstResponse = await axios.get("https://www.spotops360.com/orders/monthly", {
        params: { month, year, page: 1, limit },
        headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
      });

      let yardOrdersRaw = [...firstResponse.data.orders];
      const totalPages = Math.ceil(firstResponse.data.totalCount / limit);

      const requests = [];
      for (let p = 2; p <= totalPages; p++) {
        requests.push(
          axios.get("https://www.spotops360.com/orders/monthly", {
            params: { month, year, page: p, limit },
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
          })
        );
      }
      const responses = await Promise.all(requests);
      responses.forEach(res => {
        yardOrdersRaw.push(...res.data.orders);
      });

      yardOrders = yardOrdersRaw
        .map(order => {
          // only keep additionalInfo with reimbursedDate
          const filteredInfo = order.additionalInfo.filter(
            info => info.reimbursedDate && info.reimbursedDate.trim() !== ""
          );
          if (filteredInfo.length > 0) {
            return { ...order, additionalInfo: filteredInfo };
          }
          return null;
        })
        .filter(order => order !== null);

      renderTableRows(currentPage, yardOrders);
      createPaginationControls(Math.ceil(yardOrders.length / rowsPerPage));
    } catch (error) {
      console.error("Error fetching yard info:", error);
      alert("Failed to fetch data. Please try again.");
    } finally {
      $("#loadingMessage").hide();
    }
  }

  // Render table + totals
  function renderTableRows(page, data = yardOrders) {
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = data.slice(start, end);

    $("#yardInfoTable").empty();
    $("#tableHeader th:gt(1)").remove();

    pageData.forEach(order => {
      let yardInfoHtml = "";
      let totalCardCharged = 0;
      order.additionalInfo.forEach(info => {
        const partPrice = parseFloat(info.partPrice || 0);
        const others = parseFloat(info.others || 0);
        totalCardCharged += partPrice + others;
        yardInfoHtml += `<td>${info.yardName || ""}<br>Part price: $${partPrice} | Others: $${others}</td>`;
      });

      const date = new Date(order.orderDate);
      const formattedOrderDate = `${date.getUTCDate()}-${date.getUTCMonth()+1}-${date.getUTCFullYear()}`;

      $("#yardInfoTable").append(
        `<tr>
          <td>${order.orderNo}</td>
          <td>${formattedOrderDate}</td>
          ${yardInfoHtml}
          <td>$${totalCardCharged.toFixed(2)}</td>
          <td><button class="btn btn-success btn-sm process-btn" data-id="${order.orderNo}">View</button></td>
        </tr>`
      );
    });

    // Totals: total orders − reimbursed amount
    const totalOrders = yardOrders.length;
    let totalReimbursed = 0;
    yardOrders.forEach(order => {
      order.additionalInfo.forEach(info => {
        const amt = parseFloat(info.reimbursementAmount || 0);
        totalReimbursed += isNaN(amt) ? 0 : amt;
      });
    });

    document.getElementById("showTotalOrders").innerHTML =
      `Total Orders: ${totalOrders} | Net: ${totalOrders - totalReimbursed}`;
  }

  function createPaginationControls(totalPages) {
    const paginationControls = $('#pagination-controls');
    paginationControls.empty(); 
    if (totalPages > 1) {
      paginationControls.append(`<button id="prevPage" ${currentPage === 1 ? 'disabled' : ''}>←</button>`);
      paginationControls.append(`<span>Page ${currentPage} of ${totalPages}</span>`);
      paginationControls.append(`<button id="nextPage" ${currentPage === totalPages ? 'disabled' : ''}>→</button>`);
    }
  }

  // Filter button → uses reimbursedDate
  $("#filterButton").click(async function () {
    try {
      const rangeValue = $("#unifiedDatePicker").val().trim();
      const tz = "America/Chicago";
      let month, year;
      if (moment(rangeValue, "YYYY-MM-DD", true).isValid()) {
        const mObj = moment.tz(rangeValue, "YYYY-MM-DD", tz);
        month = mObj.format("MMM");
        year = mObj.format("YYYY");
      } else if (rangeValue.includes(" to ")) {
        const [startStr] = rangeValue.split(" to ");
        const mObj = moment.tz(startStr, "YYYY-MM-DD", tz);
        month = mObj.format("MMM");
        year = mObj.format("YYYY");
      } else if (moment(rangeValue, "YYYY-MM", true).isValid()) {
        const mObj = moment(rangeValue, "YYYY-MM");
        month = mObj.format("MMM");
        year = mObj.format("YYYY");
      } else {
        alert("⚠️ Please select a valid date, range, or month.");
        return;
      }
      currentPage = 1;
      await fetchYardInfo(month, year);
      createPaginationControls(Math.ceil(yardOrders.length / rowsPerPage));
    } catch (err) {
      console.error(err);
      alert("Error filtering data");
    }
  });

  // init
  const now = moment().tz("America/Chicago");
  await fetchYardInfo(now.format("MMM"), now.format("YYYY"));
});
</script>
</body>
</html>
