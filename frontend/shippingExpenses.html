<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shipping Expenses</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
    <style>
      body {
        display: flex;
        overflow-x: hidden;
        flex-direction: column;
      }
      #searchInput {
        width: 40%;
        border-radius: 30px;
        border: 1px solid grey;
        margin: 1% 28%;
        background: white url(https://assets-autoparts.s3.ap-south-1.amazonaws.com/images/magnify.png) 5px center no-repeat;
        background-size: 20px 20px;
        padding-left: 35px;
        height: 40px;
      }
      #logoImg {
        height: auto;
        width: 150px;
        margin: -16px 6px;
      }
      .navbar .user-info span {
        margin-right: 10px;
        color: white;
      }
      .navbar .user-icon {
        color: white;
        cursor: pointer;
      }
      .navbar {
        color: white;
        background-color: black;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 2;
        border-bottom: 1px solid #e0e0e0;
      }
      .sidebar {
        background-color: black;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        overflow-x: hidden;
        padding-top: 20px;
        width: 13%;
        height: 100vh;
        padding: 50px 0px;
        transition: transform 0.3s ease;
      }
      .sidebar .nav-link {
        color: #ffffff;
        cursor: pointer;
      }
      .sidebar .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .sidebar .nav-link.active,
      .sidebar .nav-link.selected {
        background-color: rgba(255, 255, 255, 0.2);
        cursor: default;
        border: none;
      }
      .main-content {
        text-align: center;
        flex-grow: 1;
        padding: 20px;
        margin-left: 14%;
        margin-top: 30px;
        transition: margin-left 0.3s ease;
      }
      .submenu {
        display: block; /* Show all submenus by default */
      }
      .nav-item > .submenu {
        padding-left: 20px;
      }
      .nav-item .nav-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-item .nav-link i {
        margin-right: 10px;
      }
      .chevron-icon {
        margin-left: auto;
        cursor: pointer;
      }
      .submenu .nav-link {
        display: block;
        margin-left: 20px;
      }
      .toggle-sidebar {
        display: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          width: 70%;
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .main-content {
          margin-left: 0;
        }
        .toggle-sidebar {
          display: block;
        }
      }
      .sort-icon {
        margin-left: 5px;
        cursor: pointer;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const firstName = localStorage.getItem("firstName");
      if (!firstName) {
        window.location.href = "login_signup.html";
      }

      $(document).ready(function () {
        let currentSort = {
            column: "",
            order: "asc" // ascending by default
        };

        function sortTable(column, order, isNumeric = false, isDate = false) {
            const tbody = $("#yardInfoTable");
            const rows = tbody.find("tr").toArray();

            rows.sort(function (a, b) {
                let cellA = $(a).find("td").eq(column).text().trim();
                let cellB = $(b).find("td").eq(column).text().trim();

                if (isNumeric) {
                    cellA = parseFloat(cellA.replace(/[^0-9.-]+/g, ""));
                    cellB = parseFloat(cellB.replace(/[^0-9.-]+/g, ""));
                } else if (isDate) {
                    cellA = new Date(cellA);
                    cellB = new Date(cellB);
                }

                return order === "asc" ? (cellA > cellB ? 1 : -1) : (cellA < cellB ? 1 : -1);
            });

            // Append sorted rows back to the table body
            $.each(rows, function (index, row) {
                tbody.append(row);
            });
        }

        // Click event for sorting Yard columns (alphabetical sorting)
        $(document).on("click", ".fYardName", function () {
            const column = $(this).closest("th").index();
            const sortBy = $(this).closest("th").data("sort");

            currentSort.order = currentSort.column === sortBy && currentSort.order === "asc" ? "desc" : "asc";
            currentSort.column = sortBy;

            sortTable(column, currentSort.order, false, false);

            $(".fYardName").html("&#9650;"); // Reset all icons to ascending
            $(this).html(currentSort.order === "asc" ? "&#9650;" : "&#9660;");
        });

        // Click event for sorting numeric columns
        $(document).on("click", ".onlyNumberOrder", function () {
            const column = $(this).closest("th").index();
            const sortBy = $(this).closest("th").data("sort");

            currentSort.order = currentSort.column === sortBy && currentSort.order === "asc" ? "desc" : "asc";
            currentSort.column = sortBy;

            // Check if sorting by date or numeric
            const isDate = sortBy === 'orderDate';
            const isNumeric = !isDate;

            sortTable(column, currentSort.order, isNumeric, isDate);

            $(".onlyNumberOrder").html("&#9650;"); // Reset all icons to ascending
            $(this).html(currentSort.order === "asc" ? "&#9650;" : "&#9660;");
        });

        async function fetchData() {
            try {
                const token = localStorage.getItem("token");
                const response = await axios.get("https://www.spotops360.com/yardInfo", {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (response.status !== 200) {
                    throw new Error("Failed to fetch shipping expenses information");
                }

                const data = response.data;

                // Check if data is an array
                if (!Array.isArray(data)) {
                    throw new Error("Data is not an array");
                }

                renderTable(data);
            } catch (error) {
                console.error("Error fetching shipping expenses information:", error);
                alert("Error fetching shipping expenses information: " + error.message);
            }
        }

        function renderTable(data) {
            const tableHeader = $("#tableHeader");
            const tableFooter = $("#tableFooter");
            $("#yardInfoTable").empty();
            let maxYards = 0;
            let totalShippingSum = 0;

            data.forEach((item) => {
                if (item.additionalInfo.length > maxYards) {
                    maxYards = item.additionalInfo.length;
                }
            });

            tableHeader.find("th:gt(1)").remove(); // Remove all columns after Order Date
            for (let i = 1; i <= maxYards; i++) {
                tableHeader.append(`<th scope="col" data-sort="yard${i}">Yard ${i} <span class="sort-icon fYardName">&#9650;</span></th>`);
            }
            tableHeader.append('<th scope="col" data-sort="totalShipping">Total Shipping($) <span class="sort-icon onlyNumber">&#9650;</span></th>');
            tableHeader.append('<th scope="col">Actions</th>');

            data.forEach((item) => {
                if (item.additionalInfo.length > 0) {
                    let yardInfoHtml = "";
                    let totalShipping = 0;

                    for (let i = 0; i < maxYards; i++) {
                        if (item.additionalInfo[i]) {
                            // Check if shippingDetails exist
                            let shippingDetails = item.additionalInfo[i].shippingDetails;
                            let shippingCharge = 0;

                            if (shippingDetails) {
                                const shippingArray = shippingDetails.split(":");
                                shippingCharge = parseFloat(shippingArray[1]?.trim() || 0);
                            }

                            totalShipping += shippingCharge;

                            yardInfoHtml += `<td data-sort-value="${shippingCharge}">
                                ${item.additionalInfo[i].yardName || ""} | ${item.additionalInfo[i].shippingMethod || ""} ($${shippingCharge.toFixed(2) || "0"})<br>
                            </td>`;
                        } else {
                            yardInfoHtml += "<td data-sort-value='0'></td>";
                        }
                    }

                    totalShippingSum += totalShipping;

                    $("#yardInfoTable").append(
                        `<tr>
                            <td>${item.orderNo}</td>
                            <td>${item.orderDate}</td>
                            ${yardInfoHtml}
                            <td data-sort-value="${totalShipping}">${totalShipping.toFixed(2)}</td>
                            <td><button class="btn btn-success btn-sm process-btn" data-id="${item.orderNo}">View</button></td>
                        </tr>`
                    );
                }
            });

            const colSpan = maxYards + 2; // Including Order No and Order Date columns
            tableFooter.find("tr").html(`
                <td colspan="${colSpan}"></td>
                <td id="totalShipping">$${totalShippingSum.toFixed(2)}</td>
                <td></td>
            `);
        }

        // Fetch and display data
        fetchData();

        $("#yardInfoTable").on("click", ".process-btn", function () {
            const id = $(this).data("id");
            window.location.href = `form.html?orderNo=${id}&process=true`;
        });

        // Highlight active link based on current URL
        const currentPath = window.location.pathname;
        $(".nav-link").each(function () {
            if (currentPath.includes($(this).attr("href"))) {
                $(this).addClass("active");
            }
        });

        $("#searchInput").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            let totalShippingSum = 0;

            $("#yardInfoTable tr").filter(function () {
                const isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggle(isMatch);

                if (isMatch) {
                    const totalShipping = parseFloat($(this).find("td").eq(-2).text()) || 0;
                    totalShippingSum += totalShipping;
                }
            });

            $("#totalShipping").text(`$${totalShippingSum.toFixed(2)}`);
        });

        $(".toggle-sidebar").on("click", function () {
            $("#offcanvasSidebar").toggleClass("show");
        });

        $(".nav-link").on("click", function () {
            $(".nav-link").removeClass("active selected");
            $(this).addClass("selected");

            const contentMap = {
                "dashboards-link": "#yard-info-content",
                "users-link": "#users-content",
                "teams-link": "#teams-content",
                "reports-link": "#reports-content",
                "profile": "#profile-content",
            };

            $(".main-content > div").addClass("d-none");
            $(contentMap[this.id]).removeClass("d-none");
            $("#offcanvasSidebar").removeClass("show");
        });

        $(".chevron-icon, .nav-link").on("click", function (event) {
            event.stopPropagation();
            const submenu = $(this).closest(".nav-item").find(".submenu");
            submenu.toggle();
            $(this).find("i").toggleClass("fa-chevron-right fa-chevron-down");
            $(this).closest(".nav-link").toggleClass("selected");
        });

        $("#profile").click(function () {
            $("#profileFirstName").val(localStorage.getItem("firstName"));
            $("#profileLastName").val(localStorage.getItem("lastName"));
            $("#profileEmail").val(localStorage.getItem("email"));
            $("#profileRole").val(localStorage.getItem("role"));
            $("#profileModal").modal("show");
        });

        $(".close").click(function () {
            location.reload();
        });

        $('#logoutLink').on('click', function() {
            window.localStorage.clear();
            window.location.href = 'login_signup.html';
        });
    });
    </script>
  </body>
</html>
