<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM Form</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .input-group-text {
        font-weight: bold;
      }
      .shipping-input,
      .status-input,
      .payment-input,
      .tracking-input {
        margin-top: 10px;
      }
      .yard-details {
        display: none;
      }
      .yard-btn {
        margin-right: 10px;
      }
      .sidebarOrder {
        width: 30%;
        padding: 20px;
        background-color: #f8f9fa;
        border-left: 1px solid #ddd;
        position: fixed;
        right: 0;
        top: 0;
        height: 100%;
        margin: 55px 180px;
        overflow-y: auto;
      }
      .main-content {
        margin: -12px 180px;
        padding: 74px;
        width: 46%;
      }
      .container {
        display: flex;
        flex-direction: column;
      }
      body {
        background-color: #f8f9fa;
        display: flex;
        overflow-x: hidden;
        flex-direction: column;
      }
      .form-container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-control {
        height: calc(2.25rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
      }
      .timeline {
        position: relative;
        padding: 21px 0;
        list-style: none;
        text-align: left;
      }
      .timeline::before {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        width: 4px;
        background: transparent;
        border-left: 2px dotted grey;
        left: 20px;
        margin: 34px 12px -1px;
      }
      .timeline-item {
        margin-bottom: 20px;
        position: relative;
      }
      .timeline-item::before,
      .timeline-item::after {
        content: "";
        display: table;
      }
      .timeline-item::after {
        clear: both;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 15px;
        width: 14px;
        height: 14px;
        transform: rotate(45deg);
        background: #5f9f9f;
        border: 4px solid #c5c5c5;
        margin: 12px;
        transition: transform 0.4s ease;
      }
      .timeline-item:hover::before {
        transform: rotate(405deg);
      }
      .timeline-item .timeline-panel {
        position: relative;
        width: calc(100% - 75px);
        float: right;
        padding: 0 20px;
        text-align: left;
        border-radius: 2px;
      }
      .timeline-item .timeline-panel .timeline-heading {
        font-weight: normal;
        margin-bottom: 10px;
        color: black;
        background-color: #cce0e0;
        padding: 10px;
        border-radius: 2px;
      }
      .timeline-item .timeline-panel .timeline-body {
        color: black;
        padding: 10px;
        border-radius: 2px;
      }
      .timeline-item:hover .timeline-heading {
        background: #f8da69;
      }
      .navbar {
        color: black;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 2;
        border-bottom: 1px solid #e0e0e0;
      }
      #logoImg {
        height: auto;
        width: 150px;
        margin: -16px 6px;
      }
      .navbar .user-info {
        display: flex;
        align-items: center;
      }
      .navbar .user-info span {
        margin-right: 10px;
        color: black;
      }
      .navbar .user-icon {
        color: black;
        cursor: pointer;
      }
      .dropdown-menu {
        right: 0;
        left: auto;
      }
      .sidebar {
        background-color: #006666;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        overflow-x: hidden;
        padding-top: 20px;
        width: 14%;
        height: 100vh;
        padding: 50px 14px;
      }
      .sidebar .nav-link {
        color: #ffffff;
      }
      .sidebar .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .sidebar .nav-link.active,
      .sidebar .nav-link.selected {
        background-color: rgba(255, 255, 255, 0.2);
        cursor: default;
        border: none;
      }
      .toggle-btn,
      .close-btn {
        position: fixed;
        top: 75px;
        z-index: 1030;
        cursor: pointer;
        color: #fff;
      }
      .toggle-btn {
        left: 15px;
      }
      .close-btn {
        left: 220px;
        display: none;
      }
      .sidebar.hide {
        transform: translateX(-100%);
      }
      .submenu {
        display: none;
      }
      .nav-item > .submenu {
        padding-left: 20px;
      }
      .nav-item .nav-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-item .nav-link i {
        margin-right: 10px;
      }
      .chevron-icon {
        margin-left: auto;
        cursor: pointer;
      }
      .submenu .nav-link {
        display: block;
        margin-left: 20px;
      }
      .profile-table {
        width: 50%;
        margin: 20px auto;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }
      .profile-table input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      table.table td,
      table.table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .add-yard-btn {
        margin-left: 10px;
        font-size: 1.5rem;
        font-weight: bold;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div class="navbar">
      <div class="logo">
        <img id="logoImg" src="/images/darkLogo.png" alt="Logo" />
      </div>
      <div class="user-info dropdown">
        <span>Welcome <span id="user-name"></span></span>
        <i
          class="fas fa-user-circle fa-2x user-icon"
          id="userMenu"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
        ></i>
        <div
          class="dropdown-menu dropdown-menu-right"
          aria-labelledby="userMenu"
        >
          <a class="dropdown-item" href="#" id="profileLink"
            ><i class="fas fa-user"></i> My Profile</a
          >
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#" id="logoutLink"
            ><i class="fas fa-sign-out-alt"></i> Log Out</a
          >
        </div>
      </div>
    </div>

    <div class="toggle-btn">
      <span class="navbar-toggler-icon"></span>
    </div>
    <div class="close-btn">
      <span>&times;</span>
    </div>

    <div class="sidebar" id="offcanvasSidebar">
      <div class="offcanvas-body">
        <nav class="nav flex-column">
          <div class="nav-item">
            <a class="nav-link" href="#" id="default-link">
              <i class="fas fa-home"></i> Dashboards
              <span class="chevron-icon"
                ><i class="fas fa-chevron-right"></i
              ></span>
            </a>
            <div class="submenu" id="submenu-dashboards">
              <a class="nav-link" href="form.html?newEntry=true"
                >Add New Order</a
              >
              <a class="nav-link" href="orders.html">View Orders</a>
              <a class="nav-link" href="ordersMark.html">TeamA Orders</a>
              <a class="nav-link" href="ordersSussane.html">TeamB Orders</a>
              <a class="nav-link" href="placedOrders.html">Placed Orders</a>
              <a class="nav-link" href="cancelledOrders.html"
                >Cancelled Orders</a
              >
              <a class="nav-link" href="yardInfo.html">Yard Details</a>
            </div>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#">
              <i class="fas fa-users"></i> Users
              <span class="chevron-icon"
                ><i class="fas fa-chevron-right"></i
              ></span>
            </a>
            <div class="submenu" id="submenu-users">
              <a class="nav-link" href="createUser.html">Create User</a>
              <a class="nav-link" href="viewallUsers.html">View Users</a>
            </div>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#">
              <i class="fas fa-users-cog"></i> Teams
              <span class="chevron-icon"
                ><i class="fas fa-chevron-right"></i
              ></span>
            </a>
            <div class="submenu" id="submenu-teams">
              <a class="nav-link" href="teams.html">View Teams</a>
            </div>
          </div>
          <div class="nav-item">
            <a class="nav-link" href="#">
              <i class="fas fa-chart-bar"></i> Reports
              <span class="chevron-icon"
                ><i class="fas fa-chevron-right"></i
              ></span>
            </a>
            <div class="submenu" id="submenu-reports">
              <a class="nav-link" href="shippingExpenses.html"
                >Shipping Expenses</a
              >
              <a class="nav-link" href="purchases.html">Purchases</a>
              <a class="nav-link" href="poReport.html">PO Report</a>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <div class="main-content">
      <form id="crmForm">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="orderNo">Order No</label>
            <input type="text" class="form-control" id="orderNo" required />
          </div>
          <div class="form-group col-md-6">
            <label for="orderDate">Order Date</label>
            <input type="date" class="form-control" id="orderDate" required />
          </div>
        </div>
        <div class="form-group">
          <label for="salesAgent">Sales Agent</label>
          <input type="text" class="form-control" id="salesAgent" required />
        </div>
        <div class="form-group">
          <label for="customerInfo">Customer Info</label>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="customerName">Customer Name</label>
              <input
                type="text"
                class="form-control"
                id="customerName"
                required
              />
            </div>
            <div class="form-group col-md-6">
              <label for="bAddress">Billing Address</label>
              <input type="text" class="form-control" id="bAddress" required />
            </div>
            <div class="form-group col-md-6">
              <label for="sAddress">Shipping Address</label>
              <input type="text" class="form-control" id="sAddress" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="form-group col-md-6">
              <label for="phone">Phone</label>
              <input type="number" class="form-control" id="phone" required />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="partDescription">Part Description</label>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="make">Make</label>
              <input type="text" class="form-control" id="make" required />
            </div>
            <div class="form-group col-md-6">
              <label for="model">Model</label>
              <input type="text" class="form-control" id="model" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="year">Year</label>
              <input type="number" class="form-control" id="year" required />
            </div>
            <div class="form-group col-md-6">
              <label for="pReq">Part Required</label>
              <input type="text" class="form-control" id="pReq" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="desc">Description</label>
              <input type="text" class="form-control" id="desc" />
            </div>
            <div class="form-group col-md-6">
              <label for="warranty">Warranty</label>
              <input type="number" class="form-control" id="warranty" />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="priceProfit">Price and Profit Information</label>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="soldP">Quoted Price</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input type="number" class="form-control" id="soldP" required />
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="costP">Yard Price</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input type="number" class="form-control" id="costP" required />
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="shippingFee">Shipping</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input
                  type="number"
                  class="form-control"
                  id="shippingFee"
                  required
                />
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="salestax">Sales Tax(%)</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input
                  type="number"
                  class="form-control"
                  id="salestax"
                  readonly
                  required
                />
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="grossProfit">Gross Profit</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">$</span>
              </div>
              <input
                type="number"
                class="form-control"
                id="grossProfit"
                readonly
                required
              />
            </div>
          </div>
        </div>
        <div id="yardButtonsContainer" class="d-flex">
          <div id="yardInfoContainer" class="mr-3"></div>
          <button type="button" class="btn add-yard-btn">+</button>
        </div>
        <div id="trackingInfoContainer"></div>
        <div class="form-group">
          <label for="orderStatus">Order Status</label>
          <select class="form-control" id="orderStatus" required>
            <option value="Placed">Order Placed</option>
            <option value="Customer approved">Customer Approved</option>
            <option value="Yard Processing">Yard Processing</option>
            <option value="In Transit">In Transit</option>
            <option value="Escalation">Escalation</option>
            <option value="Order Fulfilled">Order Fulfilled</option>
            <option value="Order Cancelled">Order Cancelled</option>
            <option value="Part Delivered">Part Delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vin">VIN No.</label>
          <input type="number" class="form-control" id="vin" required />
        </div>
        <div class="form-group">
          <label for="issueOrder">Issue Order</label>
          <input type="text" class="form-control" id="issueOrder" required />
        </div>
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
          Submit
        </button>
      </form>
    </div>

    <div class="sidebarOrder">
      <h2>Order History</h2>
      <ul id="orderHistoryList" class="timeline"></ul>
    </div>

    <!-- Yard Information Modal -->
    <div
      class="modal fade"
      id="yardModal"
      tabindex="-1"
      aria-labelledby="yardModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="yardModalLabel">Yard Information</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-6">
                <input
                  type="text"
                  class="form-control"
                  id="yardName"
                  placeholder="Yard Name"
                />
              </div>
              <div class="form-group col-md-6">
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  placeholder="Address"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  placeholder="City"
                />
              </div>
              <div class="form-group col-md-4">
                <input
                  type="text"
                  class="form-control"
                  id="state"
                  placeholder="State"
                />
              </div>
              <div class="form-group col-md-4">
                <input
                  type="number"
                  class="form-control"
                  id="zip"
                  placeholder="Zip Code"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="Phone Number"
                />
              </div>
              <div class="form-group col-md-6">
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  placeholder="Email"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <input
                  type="text"
                  class="form-control"
                  id="agentName"
                  placeholder="Agent Name"
                />
              </div>
              <div class="form-group col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="partPrice"
                  placeholder="Part Price"
                />
              </div>
            </div>
            <div class="form-group">
              <div class="form-row">
                <div class="col-md-6">
                  <label class="radio-inline">
                    <input
                      type="radio"
                      name="shippingMethod"
                      value="own_shipping"
                    />
                    Own Shipping
                  </label>
                  <input
                    type="number"
                    class="form-control shipping-input"
                    id="ownShippingInput"
                    placeholder="Own Shipping Price"
                    style="display: none"
                  />
                </div>
                <div class="col-md-6">
                  <label class="radio-inline">
                    <input
                      type="radio"
                      name="shippingMethod"
                      value="yard_shipping"
                    />
                    Yard Shipping
                  </label>
                  <input
                    type="number"
                    class="form-control shipping-input"
                    id="yardShippingInput"
                    placeholder="Yard Shipping Price"
                    style="display: none"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="addYardInfo">
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Yard status Modal starts here-->
    <div
      class="modal fade"
      id="editYardModal"
      tabindex="-1"
      aria-labelledby="editYardModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editYardModalLabel">
              Edit Yard Information
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="refund">Status:</label>
              <select class="form-control" id="refund">
                <option value="">Choose</option>
                <option value="Yard PO Sent">Yard PO Sent</option>
                <option value="Card charged">Card Charged</option>
                <option value="Part shipped">Part Shipped</option>
                <option value="Part delivered">Part Delivered</option>
                <option value="Bad part">Bad Part</option>
                <option value="In return">In Return</option>
                <option value="Collect refund">Collect Refund</option>
                <option value="Refund collected">Refund Collected</option>
                <option value="Part returned">Refund Done</option>
              </select>
              <div id="notesContainer" style="display: none">
                <label for="notesInput">Notes</label>
                <input type="text" id="notesInput" class="form-control" />
                <button
                  type="button"
                  id="updateNotesButton"
                  class="btn btn-primary mt-2"
                >
                  Update
                </button>
                <div id="notesList"></div>
                <!-- Container to display all notes -->
              </div>
            </div>
            <!-- tracking info table -->
            <div class="form-group" id="divTrackingEdit" style="display: none">
              <label>Tracking Information:</label>
              <!-- Include the new Send Email button below the tracking info table -->
              <table class="table table-bordered" id="trackingTableEdit">
                <thead>
                  <tr>
                    <th>Tracking No</th>
                    <th>ETA</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <input
                        type="text"
                        class="form-control"
                        id="trackingNoEdit"
                        placeholder="Enter Tracking No"
                        required
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="form-control"
                        id="etaEdit"
                        placeholder="Enter ETA"
                        required
                      />
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2">
                      <select
                        class="form-control"
                        id="shipperNameEdit"
                        required
                      >
                        <option value="" disabled selected>
                          Select Shipper
                        </option>
                        <option value="UPS">UPS</option>
                        <option value="World Wide Express">
                          World Wide Express
                        </option>
                        <option value="FedEx">FedEx</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2">
                      <input
                        type="url"
                        class="form-control"
                        id="linkInput"
                        placeholder="Enter Link"
                        required
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
              <button
                type="button"
                class="btn btn-primary"
                id="sendEmailButton"
                style="display: none"
              >
                Send Email
              </button>
            </div>
          </div>
          <input type="hidden" id="yardIndexEdit" />
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="editYardInfo">
              Edit
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Yard status ends Modal -->

    <!-- Edit Yard Details Modal -->
    <div
      class="modal fade"
      id="editYardDetailsModal"
      tabindex="-1"
      aria-labelledby="editYardDetailsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editYardDetailsModalLabel">
              Edit Yard Details
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="editYardName">Yard Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editYardName"
                  placeholder="Yard Name"
                />
              </div>
              <div class="form-group col-md-6">
                <label for="editAddress">Address</label>
                <input
                  type="text"
                  class="form-control"
                  id="editAddress"
                  placeholder="Address"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="editCity">City</label>
                <input
                  type="text"
                  class="form-control"
                  id="editCity"
                  placeholder="City"
                />
              </div>
              <div class="form-group col-md-4">
                <label for="editState">State</label>
                <input
                  type="text"
                  class="form-control"
                  id="editState"
                  placeholder="State"
                />
              </div>
              <div class="form-group col-md-4">
                <label for="editZip">Zip Code</label>
                <input
                  type="number"
                  class="form-control"
                  id="editZip"
                  placeholder="Zip Code"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="editPhone">Phone Number</label>
                <input
                  type="text"
                  class="form-control"
                  id="editPhone"
                  placeholder="Phone Number"
                />
              </div>
              <div class="form-group col-md-6">
                <label for="editEmail">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="editEmail"
                  placeholder="Email"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="editAgentName">Agent Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editAgentName"
                  placeholder="Agent Name"
                />
              </div>
              <div class="form-group col-md-6">
                <label for="editPartPrice">Part Price</label>
                <input
                  type="number"
                  class="form-control"
                  id="editPartPrice"
                  placeholder="Part Price"
                />
              </div>
            </div>
            <div class="form-group">
              <div class="form-row">
                <div class="col-md-6">
                  <label class="radio-inline">
                    <input
                      type="radio"
                      name="editShippingMethod"
                      value="Own shipping"
                    />
                    Own Shipping
                  </label>
                  <input
                    type="number"
                    class="form-control shipping-input"
                    id="editOwnShippingInput"
                    placeholder="Own Shipping Price"
                    style="display: none"
                  />
                </div>
                <div class="col-md-6">
                  <label class="radio-inline">
                    <input
                      type="radio"
                      name="editShippingMethod"
                      value="Yard shipping"
                    />
                    Yard Shipping
                  </label>
                  <input
                    type="number"
                    class="form-control shipping-input"
                    id="editYardShippingInput"
                    placeholder="Yard Shipping Price"
                    style="display: none"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveYardDetails">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(async function () {
        // Navbar and sidebar functionalities
        const firstName = localStorage.getItem("firstName");
        const role = localStorage.getItem("role");
        const email = localStorage.getItem("email");
        const urlParams = new URLSearchParams(window.location.search);
        const orderNo = urlParams.get("orderNo");
        const process = urlParams.get("process");
        const newEntry = urlParams.get("newEntry");
        const team = localStorage.getItem("team");

        console.log("orderNo:", orderNo); // Debugging: Check if orderNo is retrieved correctly
        console.log("process:", process); // Debugging: Check if process is retrieved correctly
        console.log("newEntry:", newEntry); // Debugging: Check if newEntry is retrieved correctly
        console.log("team", team);

        // Fetch the token from the server
        let token = null;
        async function fetchToken() {
          try {
            const response = await axios.get(
              "http://localhost:3000/auth/token"
            );
            if (response.status === 200) {
              token = response.data.token;
              console.log("token form", token);
            } else {
              throw new Error("Failed to fetch token");
            }
          } catch (error) {
            console.error("Error fetching token:", error);
          }
        }

        await fetchToken();

        if (firstName) {
          $("#user-name").text(firstName);
        }

        let userRole = null;
        let userEmail = null;

        if (token) {
          try {
            const response = await axios.get("http://localhost:3000/auth/me", {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (response.status !== 200) {
              throw new Error("Failed to fetch user data");
            }

            userRole = response.data.role;
            userEmail = response.data.email;
          } catch (error) {
            console.error("Error fetching user data:", error);
            localStorage.removeItem("token");
          }
        }

        // Populate profile information
        $("#profileLink").click(function () {
          $("#profileName").val(firstName);
          $("#profileRole").val(role);
          $("#profileEmail").val(email);
          $("#placed-order-content").addClass("d-none");
          $("#profile-content").removeClass("d-none");
        });

        $("#backToOrders").click(function () {
          $("#profile-content").addClass("d-none");
          $("#placed-order-content").removeClass("d-none");
        });

        // Logout functionality
        $("#logoutLink").click(function () {
          localStorage.removeItem("token");
          localStorage.removeItem("firstName");
          localStorage.removeItem("role");
          localStorage.removeItem("email");
          window.location.href = "login_signup.html";
        });

        $(".toggle-btn").on("click", function () {
          $("#offcanvasSidebar").removeClass("hide");
        });

        $(".close-btn").on("click", function () {
          $("#offcanvasSidebar").addClass("hide");
        });

        $(".nav-link").on("click", function () {
          $(".nav-link").removeClass("active");
          $(this).addClass("active");

          const contentMap = {
            "default-link": "#default-content",
            "add-order-link": "#add-order-content",
            "view-order-link": "#view-order-content",
          };

          $(".main-content > div").addClass("d-none");
          $(contentMap[this.id]).removeClass("d-none");
          $("#offcanvasSidebar").addClass("hide");
        });

        $(".chevron-icon").on("click", function (event) {
          event.stopPropagation();
          const submenu = $(this).closest(".nav-item").find(".submenu");
          submenu.toggle();
          $(this).find("i").toggleClass("fa-chevron-right fa-chevron-down");
        });

        // Fetch and display teams data
        $.ajax({
          type: "GET",
          url: "http://localhost:3000/teams",
          success: function (teams) {
            const teamCharlie = $("#team-charlie");
            const teamMark = $("#team-mark");
            const teamSussane = $("#team-sussane");

            teams.forEach((team) => {
              const teamHtml = `
                ${team.name}<br>
                ${team.team}<br>
                ${team.role}
              `;
              if (team.team === "Team Charlie") {
                teamCharlie.append(teamHtml);
              } else if (team.team === "Team Mark") {
                teamMark.append(teamHtml);
              } else if (team.team === "Team Sussane") {
                teamSussane.append(teamHtml);
              }
            });
          },
          error: function (error) {
            alert("Error fetching teams: " + error.responseJSON.message);
          },
        });

        // Other existing functionalities (form submission, yard info, etc.)
        function calculateProfit() {
          const quotedPrice = parseFloat($("#soldP").val()) || 0;
          const yardPrice = parseFloat($("#costP").val()) || 0;
          const shipping = parseFloat($("#shippingFee").val()) || 0;

          const salesTax = 0.035 * quotedPrice;
          const grossProfit = quotedPrice - yardPrice;
          const netProfit = grossProfit - shipping - salesTax;

          $("#salestax").val(salesTax.toFixed(2));
          $("#grossProfit").val(netProfit.toFixed(2));
        }

        const today = new Date().toISOString().split("T")[0];
        $("#orderDate").val(today);

        $("#soldP, #costP, #shippingFee").on("input", calculateProfit);

        function showModal(modalId) {
          $(modalId).modal("show");
        }

        function addYardButton(yardIndex, buttonText) {
          const buttonHtml = `
            <button type="button" class="btn btn-info yard-btn" data-yard-index="${yardIndex}">${buttonText}</button>
            <div class="yard-details" id="yard-details-${yardIndex}"></div>
          `;
          $("#yardInfoContainer").append(buttonHtml);
        }

        function showYardDetails(yardIndex) {
          const yardDetails = $(`#yard-details-${yardIndex}`);
          if (yardDetails.is(":visible")) {
            yardDetails.hide();
          } else {
            fetch(`http://localhost:3000/orders/${orderNo}`)
              .then((response) => response.json())
              .then((data) => {
                if (
                  !data.additionalInfo ||
                  !data.additionalInfo[yardIndex - 1]
                ) {
                  return;
                }
                const yardData = data.additionalInfo[yardIndex - 1];
                let yardDetailsHtml = `
                  <table class="table table-bordered">
                    <tr>
                      <td colspan="2">${formatYardData(yardData)}</td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        <button type="button" class="btn btn-secondary edit-yard" data-yard-index="${yardIndex}">Edit Yard Status</button>
                        <button type="button" class="btn btn-secondary edit-yard-details" data-yard-index="${yardIndex}">Edit Yard Details</button>
                      </td>
                    </tr>
                  </table>
                `;
                yardDetails.html(yardDetailsHtml).show();
              });
          }
        }

        function formatYardData(yardData) {
          let yardInfo = `
            Yard Name: ${yardData.yardName}<br>
            Address: ${yardData.address}<br>
            Email: ${yardData.email}<br>
            Phone No: ${yardData.phone}<br>
            Agent Name: ${yardData.agentName}<br>
            Part Price: ${yardData.partPrice}<br>
            Shipping Method: ${yardData.shippingMethod} (${yardData.shippingDetails})<br>
          `;

          if (yardData.status) {
            yardInfo += `Status: ${yardData.status}<br>`;
          }
          if (yardData.paymentStatus) {
            yardInfo += `Payment Status: ${yardData.paymentStatus}<br>`;
          }
          if (yardData.paymentDetails) {
            yardInfo += `Payment Details: ${yardData.paymentDetails}<br>`;
          }
          if (yardData.trackingNo) {
            yardInfo += `Tracking No: ${yardData.trackingNo}<br>`;
          }
          if (yardData.shipperName) {
            yardInfo += `Shipper Name: ${yardData.shipperName}<br>`;
          }

          return yardInfo;
        }

        function updateOrderHistory(orderHistory) {
          const orderHistoryList = $("#orderHistoryList");
          orderHistoryList.empty();
          orderHistory.forEach((historyItem) => {
            const [heading, ...details] = historyItem.split(" by ");
            const listItem = `
              <li class="timeline-item">
                <div class="timeline-panel">
                  <div class="timeline-heading">${heading}</div>
                  <div class="timeline-body">
                    <p>${details.join(" by ")}</p>
                  </div>
                </div>
              </li>`;
            orderHistoryList.append(listItem);
          });
        }

        if (orderNo) {
          fetch(`http://localhost:3000/orders/${orderNo}`)
            .then((response) => response.json())
            .then((data) => {
              $("#orderNo").val(data.orderNo);
              $("#orderDate").val(data.orderDate);
              $("#salesAgent").val(data.salesAgent);
              $("#customerName").val(data.customerName);
              $("#bAddress").val(data.bAddress);
              $("#sAddress").val(data.sAddress);
              $("#email").val(data.email);
              $("#phone").val(data.phone);
              $("#make").val(data.make);
              $("#model").val(data.model);
              $("#year").val(data.year);
              $("#pReq").val(data.pReq);
              $("#desc").val(data.desc);
              $("#warranty").val(data.warranty);
              $("#soldP").val(data.soldP);
              $("#costP").val(data.costP);
              $("#shippingFee").val(data.shippingFee);
              $("#salestax").val(data.salestax);
              $("#grossProfit").val(data.grossProfit);
              $("#orderStatus").val(data.orderStatus);
              $("#vin").val(data.vin);
              $("#issueOrder").val(data.issueOrder);

              data.additionalInfo.forEach((info, index) => {
                addYardButton(index + 1, `Yard ${index + 1}`);
              });

              if (data.trackingInfo) {
                $("#trackingInfoContainer").html(data.trackingInfo);
              }

              // Update order history
              updateOrderHistory(data.orderHistory);

              if (process) {
                $("#crmForm input, #crmForm select").attr("disabled", true);
                $("#orderStatus").attr("disabled", false);
              }

              if (process) {
                $("#orderStatus").on("change", function () {
                  if ($(this).val() === "yardPoSent") {
                    showModal("#yardModal");
                  }
                  if ($(this).val() === "trackingInfoSent") {
                    showModal("#trackingModal");
                  }
                });
              }

              $("#crmForm").on("submit", function (e) {
                e.preventDefault();
                const firstName = localStorage.getItem("firstName");

                const updatedData = {
                  orderNo: $("#orderNo").val(),
                  orderDate: $("#orderDate").val(),
                  salesAgent: $("#salesAgent").val(),
                  customerName: $("#customerName").val(),
                  bAddress: $("#bAddress").val(),
                  sAddress: $("#sAddress").val(),
                  email: $("#email").val(),
                  phone: $("#phone").val(),
                  make: $("#make").val(),
                  model: $("#model").val(),
                  year: $("#year").val(),
                  pReq: $("#pReq").val(),
                  desc: $("#desc").val(),
                  warranty: $("#warranty").val(),
                  soldP: $("#soldP").val(),
                  costP: $("#costP").val(),
                  shippingFee: $("#shippingFee").val(),
                  salestax: $("#salestax").val(),
                  grossProfit: $("#grossProfit").val(),
                  orderStatus: $("#orderStatus").val(),
                  vin: $("#vin").val(),
                  issueOrder: $("#issueOrder").val(),
                  firstName: firstName, // Include firstName in the request body
                };

                fetch(`http://localhost:3000/orders/${orderNo}`, {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedData),
                })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error("Network response was not ok");
                    }
                    return response.json();
                  })
                  .then((data) => {
                    updateOrderHistory(data.orderHistory); // Update order history
                    window.location.href = "orders.html";
                  })
                  .catch((error) => {
                    console.error("Error:", error);
                  });
              });

              // part desc
              partDesc = `
                Year: ${data.year}
                Make: ${data.make}
                Model: ${data.model}
                Part required: ${data.pReq}
                Desc: ${data.desc}
                VIN: ${data.vin}
                Warranty: ${data.warranty}`;
            });
        } else if (newEntry) {
          $("#crmForm").on("submit", function (e) {
            e.preventDefault();
            const firstName = localStorage.getItem("firstName");

            const newOrder = {
              orderNo: $("#orderNo").val(),
              orderDate: $("#orderDate").val(),
              salesAgent: $("#salesAgent").val(),
              customerName: $("#customerName").val(),
              bAddress: $("#bAddress").val(),
              sAddress: $("#sAddress").val(),
              email: $("#email").val(),
              phone: $("#phone").val(),
              make: $("#make").val(),
              model: $("#model").val(),
              year: $("#year").val(),
              pReq: $("#pReq").val(),
              desc: $("#desc").val(),
              warranty: $("#warranty").val(),
              soldP: $("#soldP").val(),
              costP: $("#costP").val(),
              shippingFee: $("#shippingFee").val(),
              salestax: $("#salestax").val(),
              grossProfit: $("#grossProfit").val(),
              orderStatus: $("#orderStatus").val(),
              vin: $("#vin").val(),
              issueOrder: $("#issueOrder").val(),
              orderHistory: [
                `Order placed by ${firstName} on ${new Date().toLocaleString()}`,
              ],
            };

            fetch("http://localhost:3000/orders", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newOrder),
            })
              .then((response) => response.json())
              .then((data) => {
                const team = data.team;
                console.log("Team assigned:", team);
                if (team === "Mark") {
                  window.location.href = "ordersMark.html";
                } else if (team === "Sussane") {
                  window.location.href = "ordersSussane.html";
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          });
        }

        function incrementOrderNo(orderNo) {
          const prefix = "50STARS";
          const orderNumber = parseInt(orderNo.replace(prefix, ""), 10);
          const nextOrderNumber = orderNumber + 1;
          return `${prefix}${nextOrderNumber.toString().padStart(5, "0")}`;
        }

        $("#orderStatus").on("change", function () {
          if ($(this).val() === "Yard PO sent") {
            showModal("#yardModal");
          }
          if ($(this).val() === "Part shipped") {
            $("#divTrackingEdit").show();
            $("#sendEmailButton").show(); // Show the Send Email button
          } else {
            $("#divTrackingEdit").hide();
            $("#sendEmailButton").hide();
          }
        });

        $("#yardInfoContainer").on("click", ".yard-btn", function () {
          const yardIndex = $(this).data("yard-index");
          showYardDetails(yardIndex);
        });

        $(".add-yard-btn").on("click", function () {
          showModal("#yardModal");
          const newOrderStatus = "Yard Processing";

          console.log("new order status", newOrderStatus);

          // Update the order status in the UI
          $("#orderStatus").val(newOrderStatus);

          // Update the order status in the database
          const orderNo = $("#orderNo").val(); // Ensure orderNo is retrieved correctly
          const updatedData = { orderStatus: newOrderStatus };

          fetch(`http://localhost:3000/orders/${orderNo}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedData),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              // Update order history and other necessary parts of the UI
              updateOrderHistory(data.orderHistory); // Update order history
              console.log("Order status updated successfully:", data);
            })
            .catch((error) => {
              console.error("Error updating order status:", error);
            });
        });

        $("#yardInfoContainer").on("click", ".edit-yard", function () {
          const yardIndex = $(this).data("yard-index");
          $("#editYardInfo").data("yard-index", yardIndex); // Store yardIndex in the edit button
          $("#yardIndexEdit").val(yardIndex); // Set the yard index in the hidden input
          showModal("#editYardModal");
        });

        //to update yardInfo.html
        async function fetchAndUpdateYardInfo() {
          const token =
            "d7efef519360bf1ae968db97c52855fcdfbfab171af45c4720f8b648cf2814f3069a696b70ad12bba620b5394ee11b076f4fc31bd07baee18ace4fb4c8bfed34"; // Use your provided token here
          await fetchYardInfo(token);
        }

        // Existing addYardInfo code with fetchAndUpdateYardInfo call
        $("#addYardInfo").on("click", async function () {
          const yardName = $("#yardName").val();
          const address = $("#address").val();
          const city = $("#city").val();
          const state = $("#state").val();
          const zipcode = $("#zip").val();
          const addedAddress = city + "  " + state + "  " + zipcode;
          const phone = $("#phone").val();
          const email = $("#email").val();
          const agentName = $("#agentName").val();
          const partPrice = $("#partPrice").val();
          const shippingMethod = $(
            "input[name='shippingMethod']:checked"
          ).val();
          const shippingDetails =
            shippingMethod === "own_shipping"
              ? $("#ownShippingInput").val()
              : $("#yardShippingInput").val();

          const data = {
            yardName: yardName,
            address: addedAddress,
            phone: phone,
            email: email,
            agentName: agentName,
            partPrice: partPrice,
            shippingMethod: shippingMethod,
            shippingDetails: shippingDetails,
          };

          fetch(`http://localhost:3000/orders/${orderNo}/additionalInfo`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              $("#yardModal").modal("hide");
              addYardButton(
                data.additionalInfo.length,
                `Yard ${data.additionalInfo.length}`
              );
              updateOrderHistory(data.orderHistory); // Update order history
              fetchAndUpdateYardInfo(); // Fetch and update yard info in yardInfo.html
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

        // Existing editYardInfo code with fetchAndUpdateYardInfo call
        $("#editYardInfo").on("click", async function () {
          const yardIndex = $(this).data("yard-index");
          const status = $("#refund").val();
          const paymentStatus = $("#paymentStatus").val();
          const paymentDetails = $("#paymentInput").val();
          const trackingNo = $("#trackingNoEdit").val();
          const shipperName = $("#shipperNameEdit").val();
          const shippingAddress = $("#shippingAddress").val();
          const firstName = localStorage.getItem("firstName");

          const data1 = {
            status: status,
            trackingNo: trackingNo,
            shipperName: shipperName,
            paymentStatus: paymentStatus,
            paymentDetails: paymentDetails,
            shippingAddress: shippingAddress,
            firstName: firstName, // Include firstName in the request body
          };

          fetch(
            `http://localhost:3000/orders/${orderNo}/additionalInfo/${yardIndex}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data1),
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              $("#editYardModal").modal("hide");
              updateOrderHistory(data.orderHistory); // Update order history
              showYardDetails(yardIndex); // Refresh the yard details
              fetchAndUpdateYardInfo(); // Fetch and update yard info in yardInfo.html
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

        async function fetchYardInfo(token) {
          console.log("")
          const response = await axios.get("http://localhost:3000/yardInfo", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.status !== 200) {
            throw new Error("Failed to fetch yard information");
          }

          const data = response.data;

          // Determine the maximum number of yards
          let maxYards = 0;
          data.forEach((item) => {
            if (item.additionalInfo.length > maxYards) {
              maxYards = item.additionalInfo.length;
            }
          });

          // Update the table header to include the correct number of Yard columns
          const tableHeader = $("#tableHeader");
          for (let i = 1; i <= maxYards; i++) {
            tableHeader.append(`<th scope="col">Yard ${i}</th>`);
          }

          // Append the yard information to the table body
          const yardInfoTable = $("#yardInfoTable");
          yardInfoTable.empty();
          data.forEach((item) => {
            let yardInfoHtml = "";
            for (let i = 0; i < maxYards; i++) {
              const yardClass =
                item.additionalInfo[i]?.paymentStatus === "Card charged"
                  ? "highlight-red"
                  : "";
              yardInfoHtml += `<td class="${yardClass}">${
                item.additionalInfo[i]?.yardName || ""
              }: ${item.additionalInfo[i]?.status || ""}</td>`;
            }

            yardInfoTable.append(
              `<tr>
                <td>${item.orderNo}</td>
                <td>${item.customerName}</td>
                ${yardInfoHtml}
              </tr>`
            );
          });
        }

        $("input[name='shippingMethod']").on("change", function () {
          if ($(this).val() === "own_shipping") {
            $("#ownShippingInput").show();
            $("#yardShippingInput").hide();
          } else if ($(this).val() === "yard_shipping") {
            $("#yardShippingInput").show();
            $("#ownShippingInput").hide();
          }
        });

        $("#updateNotesButton").on("click", function () {
          const note = $("#notesInput").val();
          if (note.trim() === "") {
            alert("Please enter some notes.");
            return;
          }

          const orderNo = $("#orderNo").val(); // Ensure orderNo is retrieved correctly

          fetch(`http://localhost:3000/orders/${orderNo}/notes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ note }),
          })
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw new Error(
                    `Network response was not ok: ${err.message}`
                  );
                });
              }
              return response.json();
            })
            .then((data) => {
              alert("Notes updated successfully.");
              $("#notesInput").val(""); // Clear the input field
              $("#notesContainer").hide(); // Hide the notes container
            })
            .catch((error) => {
              console.error("Error:", error);
              alert(`Failed to update notes: ${error.message}`);
            });
        });

        $("#refund").on("change", function () {
          const refundStatus = $(this).val();
          const orderStatus = $("#orderStatus").val();

          let newOrderStatus = orderStatus;

          if (refundStatus === "Part shipped") {
            newOrderStatus = "In Transit";
            $("#divTrackingEdit").show();
            $("#sendEmailButton").show(); // Show the Send Email button
            $("#notesContainer").hide();
          } else if (refundStatus === "Part delivered") {
            newOrderStatus = "Order Fulfilled";
            $("#notesContainer").show();
          } else if (
            refundStatus === "Bad part" ||
            refundStatus === "In return"
          ) {
            newOrderStatus = "Escalation";
            $("#notesContainer").show();
          } else if (
            refundStatus === "Card charged" ||
            refundStatus === "Yard PO Sent"
          ) {
            newOrderStatus = "Yard Processing";
          } else {
            $("#divTrackingEdit").hide();
            $("#sendEmailButton").hide();
            $("#notesContainer").hide();
          }

          // Update the Order Status in the MongoDB
          const updatedData = { orderStatus: newOrderStatus };

          fetch(`http://localhost:3000/orders/${orderNo}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedData),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              $("#orderStatus").val(newOrderStatus);
              updateOrderHistory(data.orderHistory); // Update order history
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

        $("#paymentStatus").on("change", function () {
          const paymentStatus = $(this).val();
          if (
            paymentStatus === "Refund collected" ||
            paymentStatus === "Collect refund"
          ) {
            $("#paymentInput").show();
          } else {
            $("#paymentInputTxt").show();
          }
        });

        $("#sendEmailButton").on("click", function () {
          const trackingNo = $("#trackingNoEdit").val();
          const eta = $("#etaEdit").val();
          const shipperName = $("#shipperNameEdit").val();
          const link = $("#linkInput").val();
          if (trackingNo && eta && shipperName && link) {
            const data = {
              trackingNo: trackingNo,
              eta: eta,
              shipperName: shipperName,
              link: link,
            };

            fetch(`http://localhost:3000/orders/sendTrackingInfo/${orderNo}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            })
              .then((response) => response.json())
              .then((result) => {
                alert("Tracking details sent to the customer");
                console.log("Success:", result);
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          } else {
            alert("Please fill in all the tracking information fields.");
          }
        });

        // Function to show Edit Yard Details modal with current yard information
        $("#yardInfoContainer").on("click", ".edit-yard-details", function () {
          const yardIndex = $(this).data("yard-index");
          fetch(`http://localhost:3000/orders/${orderNo}`)
            .then((response) => response.json())
            .then((data) => {
              if (!data.additionalInfo || !data.additionalInfo[yardIndex - 1]) {
                return;
              }
              const yardData = data.additionalInfo[yardIndex - 1];
              $("#editYardName").val(yardData.yardName);
              $("#editAddress").val(yardData.address);
              const addressParts = yardData.address.split(" ");
              $("#editCity").val(addressParts[0]);
              $("#editState").val(addressParts[1]);
              $("#editZip").val(addressParts[2]);
              $("#editPhone").val(yardData.phone);
              $("#editEmail").val(yardData.email);
              $("#editAgentName").val(yardData.agentName);
              $("#editPartPrice").val(yardData.partPrice);
              $(
                "input[name='editShippingMethod'][value='" +
                  yardData.shippingMethod +
                  "']"
              ).prop("checked", true);
              if (yardData.shippingMethod === "Own shipping") {
                $("#editOwnShippingInput").val(yardData.shippingDetails).show();
                $("#editYardShippingInput").hide();
              } else {
                $("#editYardShippingInput")
                  .val(yardData.shippingDetails)
                  .show();
                $("#editOwnShippingInput").hide();
              }

              $("#editYardDetailsModal").modal("show");
              $("#saveYardDetails").data("yard-index", yardIndex);
            });
        });

        // Function to save updated yard details
        $("#saveYardDetails").on("click", function () {
          const yardIndex = $(this).data("yard-index");
          const updatedData = {
            yardName: $("#editYardName").val(),
            address: $("#editAddress").val(),
            phone: $("#editPhone").val(),
            email: $("#editEmail").val(),
            agentName: $("#editAgentName").val(),
            partPrice: $("#editPartPrice").val(),
            shippingMethod: $("input[name='editShippingMethod']:checked").val(),
            shippingDetails:
              $("input[name='editShippingMethod']:checked").val() ===
              "Own shipping"
                ? $("#editOwnShippingInput").val()
                : $("#editYardShippingInput").val(),
          };

          fetch(
            `http://localhost:3000/orders/${orderNo}/additionalInfo/${yardIndex}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updatedData),
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              $("#editYardDetailsModal").modal("hide");
              updateOrderHistory(data.orderHistory); // Update order history
              showYardDetails(yardIndex); // Refresh the yard details
              fetchAndUpdateYardInfo(); // Fetch and update yard info in yardInfo.html
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

        // Show/Hide shipping inputs based on selected shipping method
        $("input[name='editShippingMethod']").on("change", function () {
          if ($(this).val() === "Own shipping") {
            $("#editOwnShippingInput").show();
            $("#editYardShippingInput").hide();
          } else {
            $("#editYardShippingInput").show();
            $("#editOwnShippingInput").hide();
          }
        });
      });
    </script>
  </body>
</html>
