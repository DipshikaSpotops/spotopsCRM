<!-- if team from localStorage is null, all the class="nav-item" should be enabled
if team from local Storage is Team Charlie, Teams class should be compleltely disabled and from the Dashboards, TeamA Orders and teamB Orders should be disbled
if team from local Storage is Team Mark, Teams class should be compleltely disabled and from the Dashboards, Add New Order and TeamB Orders should be disabled
if team from local Storage is Team Sussane, Teams class should be compleltely disabled and from the Dashboards, Add New Order and TeamA Orders should be disabled -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM Dashboard</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            display: flex;
            overflow-x: hidden;
            flex-direction: column;
        }
        #logoImg {
            height: auto;
            width: 150px;
            margin: -16px 6px;
        }
        .navbar .user-info span {
            margin-right: 10px;
            color: black;
        }
        .navbar .user-icon {
            color: black;
            cursor: pointer;
        }
        .navbar {
            color: black;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 2;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(to right, #006666 12.8%, white 11.5%);
        }
        .sidebar {
            background-color: #006666;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            overflow-x: hidden;
            padding-top: 20px;
            width: 14%;
            height: 100vh;
            padding: 50px 14px;
            margin: 0 -21px;
        }
        .sidebar .nav-link {
            color: #ffffff;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .sidebar .nav-link.active, .sidebar .nav-link.selected {
            background-color: rgba(255, 255, 255, 0.2);
            cursor: default;
            border: none;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 14%;
            margin-top: 60px;
        }
        .toggle-btn,
        .close-btn {
            position: fixed;
            top: 75px;
            z-index: 1030;
            cursor: pointer;
            color: #fff;
        }
        .toggle-btn {
            left: 15px;
        }
        .close-btn {
            left: 220px;
            display: none;
        }
        .sidebar.hide {
            transform: translateX(-100%);
        }
        .submenu {
            display: none;
        }
        .nav-link.collapsed + .submenu {
            display: block;
        }
        .nav-item > .submenu {
            padding-left: 20px;
        }
        .nav-item .nav-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-item .nav-link i {
            margin-right: 10px;
        }
        .chevron-icon {
            margin-left: auto;
            cursor: pointer;
        }
        .submenu .nav-link {
            display: block;
            margin-left: 20px;
        }
        table.table td,
        table.table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .highlight-red-button {
            background-color: red;
            color: white;
            border: none;
            padding: 0px 6px;
            border-radius: 5px;
            cursor: default;
            display: inline-block;
            font-size: 0.875rem;
        }
        .profile-table {
            width: 50%;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .profile-table input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .date-filter {
            margin-bottom: 20px;
        }
        .date-filter label {
            margin-right: 10px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <img id="logoImg" src="/images/darkLogo.png" alt="Logo" />
        </div>
        <div class="user-info dropdown">
            <span>Welcome <span id="user-name"></span></span>
            <i class="fas fa-user-circle fa-2x user-icon" id="userMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></i>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userMenu">
                <a class="dropdown-item" href="#" id="profileLink"><i class="fas fa-user"></i> My Profile</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Log Out</a>
            </div>
        </div>
    </div>

    <div class="toggle-btn">
        <span class="navbar-toggler-icon"></span>
    </div>
    <div class="close-btn">
        <span>&times;</span>
    </div>

    <div class="sidebar" id="offcanvasSidebar">
        <div class="offcanvas-body">
            <nav class="nav flex-column">
                <div class="nav-item">
                    <a class="nav-link" href="#" id="default-link">
                        <i class="fas fa-home"></i> Dashboards
                        <span class="chevron-icon"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <div class="submenu" id="submenu-dashboards">
                        <a class="nav-link" href="form.html?newEntry=true">Add New Order</a>
                        <a class="nav-link" href="orders.html">View Orders</a>
                        <a class="nav-link view-individualOrders-link" href="individualOrders.html">View My Orders</a>
                        <a class="nav-link" href="ordersMark.html">TeamA Orders</a>
                        <a class="nav-link" href="ordersSussane.html">TeamB Orders</a>
                        <a class="nav-link" href="placedOrders.html">Placed Orders</a>
                        <a class="nav-link" href="cancelledOrders.html">Cancelled Orders</a>
                        <a class="nav-link" href="yardInfo.html">Yard Details</a>
                        <a class="nav-link customer-approved-link" href="customerApproved.html">Customer Approved</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="fas fa-users"></i> Users
                        <span class="chevron-icon"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <div class="submenu" id="submenu-users">
                        <a class="nav-link" href="createUser.html">Create User</a>
                        <a class="nav-link" href="viewallUsers.html">View Users</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="fas fa-users-cog"></i> Teams
                        <span class="chevron-icon"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <div class="submenu" id="submenu-teams">
                        <a class="nav-link" href="teams.html">View Teams</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="fas fa-chart-bar"></i> Reports
                        <span class="chevron-icon"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <div class="submenu" id="submenu-reports">
                        <a class="nav-link" href="shippingExpenses.html">Shipping Expenses</a>
                        <a class="nav-link" href="purchases.html">Purchases</a>
                        <a class="nav-link" href="poReport.html">PO Report</a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="main-content">
        <div id="yard-info-content">
            <h1>PO Report</h1>
            <div class="date-filter">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate">
                <button class="btn btn-primary" id="filterBtn">Filter</button>
            </div>
            <div class="table-responsive mx-auto" style="max-width: 90%">
                <table class="table table-bordered mt-4">
                    <thead>
                        <tr id="tableHeader">
                            <th scope="col">Order No</th>
                            <th scope="col">Order Date</th>
                        </tr>
                    </thead>
                    <tbody id="yardInfoTable">
                        <!-- Yard information will be appended here -->
                    </tbody>
                    <tfoot id="tableFooter">
                        <tr>
                            <td colspan="2"></td>
                            <td id="totalPartPrice"></td>
                            <td id="totalShipping"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="profile-content" class="d-none">
            <h1>User Profile</h1>
            <div class="profile-table">
                <label for="profileName">Name:</label>
                <input type="text" id="profileName" readonly />
                <label for="profileRole">Team:</label>
                <input type="text" id="profileRole" readonly />
                <label for="profileEmail">Email Id:</label>
                <input type="text" id="profileEmail" readonly />
                <button class="btn btn-primary" id="backToOrders">Back</button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(async function () {
            const token = localStorage.getItem("token");
            console.log("token", token);
            let yardData = [];

            async function fetchData() {
                try {
                    const response = await axios.get("http://localhost:3000/yardInfo", {
                        headers: { Authorization: `Bearer ${token}` },
                    });

                    if (response.status !== 200) {
                        throw new Error("Failed to fetch shipping expenses information");
                    }

                    const data = response.data;
                    console.log("data", data);

                    // Check if data is an array
                    if (!Array.isArray(data)) {
                        throw new Error("Data is not an array");
                    }

                    yardData = data;
                    renderTable(data);

                } catch (error) {
                    console.error("Error fetching shipping expenses information:", error);
                    alert("Error fetching shipping expenses information: " + error.message);
                }
            }

            function renderTable(data) {
                const tableHeader = $("#tableHeader");
                const tableFooter = $("#tableFooter");
                $("#yardInfoTable").empty();
                let maxYards = 0;
                let totalPartPriceSum = 0;
                let totalShippingSum = 0;

                data.forEach((item) => {
                    if (item.additionalInfo.length > maxYards) {
                        maxYards = item.additionalInfo.length;
                    }
                });

                tableHeader.find("th:gt(1)").remove(); // Remove all columns after Order Date
                for (let i = 1; i <= maxYards; i++) {
                    tableHeader.append(`<th scope="col">Yard ${i}</th>`);
                }
                tableHeader.append('<th scope="col">Total Part Price</th>');
                tableHeader.append('<th scope="col">Total Shipping</th>');
                tableHeader.append('<th scope="col">Actions</th>');

                data.forEach((item) => {
                    if (item.additionalInfo.length > 0) { // Only append if additionalInfo length > 0
                        let yardInfoHtml = "";
                        let totalPartPrice = 0;
                        let totalShipping = 0;

                        for (let i = 0; i < maxYards; i++) {
                            if (item.additionalInfo[i]) {
                                console.log("add",item.additionalInfo[i]);
                                const partPrice = parseFloat(item.additionalInfo[i].partPrice || 0);
                                const shippingCharge = parseFloat(item.additionalInfo[i].shippingDetails || 0);
                                var yEmail = item.additionalInfo[i].email || "0"
                                console.log("yemail",yEmail);
                                totalPartPrice += partPrice;
                                totalShipping += shippingCharge;
                                var fName = localStorage.getItem("firstName");
                                var date = new Date().toLocaleString();

                                yardInfoHtml += `<td>
                                    ${item.additionalInfo[i].yardName || ""} | ${yEmail} | ${item.additionalInfo[i].phone || ""}<br>
                                    Part price: $${item.additionalInfo[i].partPrice || "0"} |  ${item.additionalInfo[i].shippingMethod || ""} ($${item.additionalInfo[i].shippingDetails || "0"}) | ${item.additionalInfo[i].status || ""} Others: $${item.additionalInfo[i].others || ""} <br>
                                    PO sent by ${fName} at ${date} <br>
                                    
                                </td>`;
                            } else {
                                yardInfoHtml += "<td></td>";
                            }
                        }

                        totalPartPriceSum += totalPartPrice;
                        totalShippingSum += totalShipping;

                        $("#yardInfoTable").append(
                            `<tr>
                                <td>${item.orderNo}</td>
                                <td>${item.orderDate}</td>
                                ${yardInfoHtml}
                                <td>${totalPartPrice.toFixed(2)}</td>
                                <td>${totalShipping.toFixed(2)}</td>
                                <td><button class="btn btn-success btn-sm process-btn" data-id="${item.orderNo}">View</button></td>
                            </tr>`
                        );
                    }
                });

                // Get the position of the "Total Part Price" and "Total Shipping" columns
                const totalPartPriceIndex = tableHeader.find('th:contains("Total Part Price")').index();
                const totalShippingIndex = tableHeader.find('th:contains("Total Shipping")').index();

                // Create the footer row with empty cells up to the part price and shipping totals
                let footerHtml = '<tr>';
                for (let i = 0; i <= maxYards + 1; i++) {
                    footerHtml += '<td></td>';
                }
                footerHtml += `
                    <td id="totalPartPrice">$${totalPartPriceSum.toFixed(2)}</td>
                    <td id="totalShipping">$${totalShippingSum.toFixed(2)}</td>
                    <td></td>
                </tr>`;
                tableFooter.html(footerHtml);
            }

            $('#yardInfoTable').on('click', '.process-btn', function () {
                const id = $(this).data('id');
                window.location.href = `form.html?orderNo=${id}&process=true`;
            });

            $("#filterBtn").click(function () {
                const startDate = $("#startDate").val();
                const endDate = $("#endDate").val();

                if (startDate && endDate) {
                    const filteredData = yardData.filter(item => {
                        const orderDate = new Date(item.orderDate);
                        return orderDate >= new Date(startDate) && orderDate <= new Date(endDate);
                    });
                    renderTable(filteredData);
                } else {
                    alert("Please select both start and end date.");
                }
            });

            await fetchData();

            const firstName = localStorage.getItem("firstName");
            const role = localStorage.getItem("role");
            const email = localStorage.getItem("email");

            if (firstName) {
                $("#user-name").text(firstName);
            }

            $("#profileLink").click(function () {
                $("#profileName").val(firstName);
                $("#profileRole").val(role);
                $("#profileEmail").val(email);
                $("#yard-info-content").addClass("d-none");
                $("#profile-content").removeClass("d-none");
            });

            $("#backToOrders").click(function () {
                $("#profile-content").addClass("d-none");
                $("#yard-info-content").removeClass("d-none");
            });

            $("#logoutLink").click(function () {
                localStorage.removeItem("token");
                localStorage.removeItem("firstName");
                localStorage.removeItem("role");
                localStorage.removeItem("email");
                window.location.href = "login_signup.html";
            });

            $(".toggle-btn").on("click", function () {
                $("#offcanvasSidebar").removeClass("hide");
            });

            $(".close-btn").on("click", function () {
                $("#offcanvasSidebar").addClass("hide");
            });

            $(".nav-link").on("click", function () {
                $(".nav-link").removeClass("active");
                $(this).addClass("active");

                const contentMap = {
                    "default-link": "#default-content",
                    "add-order-link": "#add-order-content",
                    "view-order-link": "#view-order-content",
                };

                $(".main-content > div").addClass("d-none");
                $(contentMap[this.id]).removeClass("d-none");
                $("#offcanvasSidebar").addClass("hide");
            });

            $(".chevron-icon").on("click", function (event) {
                event.stopPropagation();
                const submenu = $(this).closest(".nav-item").find(".submenu");
                submenu.toggle();
                $(this).find("i").toggleClass("fa-chevron-right fa-chevron-down");
            });
            // Apply team-based restrictions
            var team = localStorage.getItem("team");
            if (team === "Team Charlie") {
                // Hide specific reports links
                $("#submenu-reports .nav-link").not(':contains("My Sales Report")').hide();
                // Hide specific dashboards links
                $("#submenu-dashboards .view-orders-link, #submenu-dashboards .teamA-orders-link, #submenu-dashboards .teamB-orders-link, #submenu-dashboards .placed-orders-link, #submenu-dashboards .cancelled-orders-link, #submenu-dashboards .yard-info-link").hide();
                $(".nav-item:has(#submenu-teams)").hide();
                $(".nav-item:has(#submenu-users)").hide();
            }else if (role === "Admin") {
                // Hide specific reports links for Admin
                $('#submenu-reports .nav-link:contains("My Sales Report")').hide();
                // Hide specific dashboards links for Admin
                $('#submenu-dashboards .view-individualOrders-link').hide();
            }else if(team === "Team Mark"){
                $('#submenu-reports .nav-link:contains("My Sales Report")').hide();
                $(".nav-item:has(#submenu-teams)").hide();
                $(".nav-item:has(#submenu-users)").hide();
                $("#submenu-dashboards .add-order-link, .view-individualOrders-link, .teamB-orders-link").hide();

            }
            else if(team === "Team Sussane"){
                $('#submenu-reports .nav-link:contains("My Sales Report")').hide();
                $(".nav-item:has(#submenu-teams)").hide();
                $(".nav-item:has(#submenu-users)").hide();
                $("#submenu-dashboards .add-order-link, .view-individualOrders-link, .teamA-orders-link").hide();

            }
        });
    </script>
</body>
</html>
